# --------------------------------------------------------------------------
# Class definition of DominantColorThread - this thread calculates the color
#
# Author: Benjamin Fuchs
# License: GPL3
#
# Website: https://github.com/bablokb/nerd-alarmclock
#
# --------------------------------------------------------------------------

from threading import Thread
import inspect
import os
import cv2
import webcolors
import numpy as np
from sklearn.cluster import KMeans
from collections import Counter


class DominantColorThread(Thread):
    """ DominantColorThread thread """

    # initialize object   ----------------------------------------------------

    def __init__(self, settings, videoStreamThread, screenThread):
        """ Constructor """

        super(DominantColorThread, self).__init__(name="DominantColorThread")
        self._settings = settings
        self._stop_event = settings.stop_event
        self._videoStreamThread = videoStreamThread
        self._screenThread = screenThread

    # run the thread   -------------------------------------------------------

    def run(self):
        """ run-method of thread """

        self.blink()
        while not self._stop_event.wait(5) and self._settings.get("screen.ready") == "false":
            self._settings.log.msg("DominantColorThread: waiting for screen coordinates...")

        self.blink()
        self._settings.log.msg("DominantColorThread: starting...")
        while not self._stop_event.is_set():
            image = self._videoStreamThread.read()
            x, y, w, h = self._settings.get("screen.coordinates")
            crop_img = image[y:y + h, x:x+w]
            path = os.path.dirname(os.path.abspath(
                inspect.getfile(inspect.currentframe())))
            cv2.imwrite(os.path.join(
                path, "web", "pic", "screen.jpg"), crop_img)
            try:
                color_0, color_1, color_2 = self.get_dominant_color(crop_img)
                self._settings.set("led.color", [webcolors.bgr_to_hex(color_0), webcolors.bgr_to_hex(color_1), webcolors.bgr_to_hex(color_2)])
            except Exception as exception:
                self._settings.log.msg(
                    "DominantColorThread: [ERROR] Could not get dominant color! (%s)" % str(exception))

        self.blink()
        self._settings.log.msg("DominantColorThread: shutdown")

    def blink(self):
        self._settings.set("led.color", webcolors.bgr_to_hex([0, 0, 0]))
        self._stop_event.wait(0.3)
        self._settings.set("led.color", webcolors.bgr_to_hex([255, 255, 255]))
        self._stop_event.wait(0.3)
        self._settings.set("led.color", webcolors.bgr_to_hex([0, 0, 0]))

    def get_dominant_color(self, bgr_image, image_processing_size=3):
        # resize image if new dims provided
        if image_processing_size is not None:
            bgr_image = cv2.resize(
                bgr_image, (image_processing_size, image_processing_size), interpolation=cv2.INTER_AREA)

        return bgr_image.tolist()[1][0], bgr_image.tolist()[0][1], bgr_image.tolist()[2][1]
