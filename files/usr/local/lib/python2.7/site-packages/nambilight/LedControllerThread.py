#!/usr/bin/python
# --------------------------------------------------------------------------
# Class definition of LedController - utility functions for the LED-strip
#
# Author: Benjamin Fuchs
# License: GPL3
#
# Website: https://github.com/benjaminfuchs/nerda
#
# --------------------------------------------------------------------------

import time
import blinkt
import requests
import webcolors
from threading import Thread


class LedControllerThread(Thread):
    """ LedControllerThread thread """

    # initialize object   ----------------------------------------------------

    def __init__(self, settings):
        """ Constructor """

        super(LedControllerThread, self).__init__(name="LedControllerThread")
        self._settings = settings
        self._stop_event = settings.stop_event
        self._brightness = settings.get('led.brightness')
        self._color = settings.get('led.color')
        self._urls = settings.get('led.urls')
        self._port = settings.get('led.port')
        self._color_current = "#000000"
        settings.add_settings_listener('led.brightness', self.on_brightness)
        settings.add_settings_listener('led.color', self.on_color)

    def run(self):
        """ run-method of thread """

        self._settings.log.msg("LedControllerThread: running LedControllerThread...")
        while not self._stop_event.wait(0.02):
            if self._settings.get("screen.ready") == "true":
                if self._color != self._color_current:
                    color_hex = webcolors.hex_to_rgb(self._color)
                    color_current = webcolors.hex_to_rgb(self._color_current)
                    new_color = []

                    for index, _ in enumerate(color_current):
                        diff = abs(color_hex[index] - color_current[index])
                        if color_hex[index] > color_current[index]:
                            new_color.append(min(color_current[index] + max(int(diff/10), 1), 255))
                        elif color_hex[index] < color_current[index]:
                            new_color.append(max(color_current[index] - max(int(diff/10), 1), 0))
                        else:
                            new_color.append(color_current[index])

                    self._color_current = webcolors.rgb_to_hex(new_color)
                    self._set_color(self._color_current)

        self._settings.log.msg("LedControllerThread: shutdown")
        self._set_color("#000000")

    # --- brightness change listener   ---------------------------------------

    def on_brightness(self, name, old, new):
        """ process brightness-changes """

        self._settings.log.msg("LedControllerThread: on_brightness(%s,%s)" % (old, new))
        self._set_brightness(new)

    # --- set the brightness of the LEDs   -----------------------------------

    def _set_brightness(self, value=None):
        """ Set the brightness of the leds """

        # we only use off and four levels, so scale new appropriately
        if not value is None:
            self._brightness = value

        self._settings.log.msg(
            "LedControllerThread: setting brightness to: %d" % self._brightness)
        for url in self._urls:
            try:
                r = requests.post("http://" + url + ":" + self._port + "/save_settings",
                                json={"led.brightness": self._brightness, "led.color": self._color})
            except requests.exceptions.ConnectionError as exception:
                self._settings.log.msg(
                    "LedControllerThread: [ERROR] Could not send color! (%s)" % str(exception))

    # --- color change listener   --------------------------------------------

    def on_color(self, name, old, new):
        """ process color-changes """

        self._settings.log.msg("LedControllerThread: on_color(%s,%s)" % (old, new))
        self._color = new

    # --- set the color of the LEDs   -----------------------------------

    def _set_color(self, value=None):
        """ Set the brightness of the leds """

        for url in self._urls:
            try:
                r = requests.post("http://" + url + ":" + self._port + "/save_settings",
                                json={"led.brightness": 1, "led.color": value})
            except requests.exceptions.ConnectionError as exception:
                self._settings.log.msg("[ERROR] Could not send color! (%s)" % str(exception))
